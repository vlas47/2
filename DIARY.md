# Дневник разработки

## 2025?12?02

- Подключил проект к PostgreSQL: вынес параметры в `settings.py`, установил `psycopg`, прогнал миграции Django.
- Создал набор специализированных приложений (новостройки, вторичка, загород, администрирование) и переработал главную страницу: теперь это промо Петербурга с историей компании и достижениями.
- Запустил служебный модуль `realestate`, импортировал полный XML?фид Setl (10?752 объектов) и настроил команду `import_setl`, которая подтягивает все ключевые поля.
- Переработал таблицу в служебном разделе: добавил фильтры, сортировку, отображение фото, площадей, идентификаторов из файла, возможность показывать только объекты с фотографиями.
- Обновил модель `RealtyOffer`, расширив её десятками дополнительных полей (цены, площади, характеристики дома, резервные поля), пересоздал базу и повторно загрузил XML.
- Допилил интерфейс: объединил адрес с метро/районом, вынес тип и название объекта, добавил колонку с фотографиями, список площадей и фильтр <Только с фото>.
- Начал вести данный дневник и оформлять описание проекта.
- Добавил режим карточек `/realestate/cards/` с переключателем, кешированием полного XML в памяти и расширенными карточками (планировка, площади, этаж/готовность, отделка, статусы, фото).

> При дальнейшей работе добавляй записи в этот файл в формате <дата - ключевые действия>, чтобы вся история изменений была под рукой.

## 2025-02-02

- Вынес инфо-хедер с показателями «Всего в базе / По фильтру» наверх страниц карточек и таблицы, рядом добавил кнопки процедур: чистка фото, чистка дублей и импорт Setl_XML.
- Оформил кнопки как формы с визуальным индикатором выполнения; для импорта добавил поле ввода пути (по умолчанию Setl_XML) и CSRF.
- Убрал дублирующие кнопки процедур из фильтров, оставив там только поиск и сброс.
- Поддержал стили для хедера и форм действий, чтобы кнопки и поле ввода выглядели аккуратно и не ломали вёрстку.

## 2025-12-03

- Добавил загрузку XML в таблицу и карточки вместо ручного пути, убрал лишние подписи в хедерах.
- Включил пагинацию карточек (10 на страницу) и навигацию, кнопки возврата на главную в таблице и карточках.
- Настроил HTTPS (certbot), nginx+gunicorn, статика отдается корректно.
- Обновил главную: крупная CTA «Поиск недвижимости», убрал лишние ссылки, хедер разнесён по колонкам.
- Подготовил роли «Администратор»/«Менеджер», миграция создает admin/admin как суперпользователя, вход через `/admin-panel/login/`, защищен доступ в админку; компактная форма входа.

## 2025-12-07

- Добавил отдельное приложение complexes с витриной карточек жилищных комплексов и подключил его в маршруты.
- Вынес кнопку «Жилищные комплексы» на страницу /realestate/cards, ведущую на новую витрину.

## 2025-12-08

- Добавил загрузку/обработку фото для первых двух ЖК: изображение масштабируется до 500px по большей стороне, сохраняется в `static/complexes_photos` и фиксируется JSON-галерея.
- Реализовал форму загрузки с выбором главного снимка, выводом текущей галереи и кнопкой «Добавить фото» на карточках, подключил новый `ComplexPhotoUploadView`.

## 2025-12-09

- Подправил стили карточек ЖК: галерея теперь строго идет третьим блоком под информацией и главным фото, миниатюры растягиваются на всю ширину, а кнопки управления — маленькие кружки в правом нижнем углу с увеличенными иконками, чтобы действия стали более очевидными.
- Исправил JS: галереи миниатюр теперь рендерятся через единый код, событие обработки «удалить»/«сделать главным» привязано и к действующей галерее карточки, поэтому кнопки сразу реагируют независимо от предыдущей загрузки.
- Устранил «пустые» ссылки для миниатюр — `data-file` теперь берётся из `photo.file` и JS рендерит имена файлов именно из поля `file`, так что кнопки получают корректные имена и запросы отправляются.
- Убрал блок статуса/лога «Система готова к загрузке файла» и списки файлов, теперь после загрузки остаётся только форма – лишняя служебная информация больше не появляется.
- Загрузил список ЖК из `complexes_list.xlsx` и стал фильтровать карточки: красные строки (FF0000) исключаю из витрины, чтобы выводились только актуальные зеленые комплексы.
- Добавил в `realestate/cards` поле выбора жилого квартала, которое берет только актуальные ЖК из Excel, и ограничил выборку предложений теми же объектами.
- Создал модель `PartnerComplex` и добавил миграцию, чтобы флаг актуальности хранился в базе; таблицу создали, импортировали данные из `complexes_list_2.xlsx` и получилось 51 активных и 46 неактуальных ЖК, поэтому сайт теперь опирается только на `PartnerComplex` при рендере карточек и фильтровании. 
- Удалил временные отладочные сообщения из галереи, чтобы блок статуса снова показывал только важные статусы.
- Добавил в карточки ЖК поле «Описание» (агрегация из описаний Setl с обрезкой до 260 символов) и убрал повторные теги локации под главным фото, чтобы слева было больше полезной информации.
- Добавил защиту в модуле complexes, теперь получение списка активных ЖК игнорирует отсутствие таблицы PartnerComplex и логирует проблему, чтобы страница `/complexes/` больше не падала при незапущенной миграции.
- Перевёл `complexes` на собственную таблицу: добавил поля (район, метро, количество квартир, статус, цена, описание), переписал сервис, чтобы он рендерил карточки исключительно из этой модели, и вынес статистику в верхний блок.
- Вложил весь расчёт карточек ЖК внутрь цикла (или 'cards' сбрасывался после каждой строки), чтобы список заполнялся полностью, и теперь все актуальные комплексы снова отображаются.

## 2025-12-10

- Написал management-команду `import_partner_complexes`, которая парсит XML-фид Setl, группирует все квартиры и апартаменты по ЖК, расставляет район, метро, статус, минимальную цену и количество предложений и сохраняет их в `PartnerComplex`.
- После импорта команда при необходимости помечает отсутствующие ЖК как неактуальные и автоматически создаёт каталоги `static/complexes_photos/<slug>` для всех активных комплексов, чтобы можно было сразу загружать фотографии.
- Добавил кнопку «Обновить данные ЖК» на витрину: при нажатии просматриваем `realestate.RealtyOffer`, пересчитываем количество квартир, минимальную цену, район и метро для активных `PartnerComplex` и обновляем карточки прямо на сервере.
- В шапке витрины появились контролы выбора конкретного ЖК и сортировки (по названию, цене и количеству квартир), чтобы быстрее находить нужный проект без прокрутки.
- Слил свежие данные по локациям/метро/описаниям из `complexes_list_3_with_metro2_km_precise.xlsx` в таблицу `PartnerComplex` — обновились все активные ЖК.
- Главная страница теперь отдаёт чистый экспорт `soyz.html`, поэтому публичный лендинг полностью совпадает с макетом из Tilda.
- Ссылку «Главный менеджер» перенёс на форму входа, оформил её как отдельную кнопку быстрого входа без пароля и добавил в кабинете компактные кнопки «ЖК / Квартиры / Выйти» для навигации.
- Исправил карточку ЖК: описание выводится без лишнего верхнего отступа — текст не уезжает вниз даже до открытия режима редактирования.
- Из файла `complexes_photos_updated_2.xlsx` выгрузил ссылки на изображения, автоматически скачал 105 фотографий для 16 ЖК и обновил галереи (`static/complexes_photos/<slug>/gallery.json`), чтобы витрина показывала реальные фото.
- Дополнительно обработал `complexes_pp.xlsx`: не удаляя старые кадры, скачал и добавил ещё 63 снимка для 10 ЖК, расширив их галереи и повторно собрал статику на сервере.
- Вдогонку импортировал `complexes_p11_first5_filled_jpg.xlsx`: докачал 35 JPEG для пяти ЖК, обновил их `gallery.json`, синхронизировал весь каталог `static/complexes_photos` на сервере и заново прогнал `collectstatic`.
- В шапке Tilda-лендинга три кнопки («Новостройки», «Вторичка», «Загородная») заменены на одну ссылку «Поиск недвижимости» и кнопку «Вход».
- Создал приложение `propertysearch` с отдельной страницей /search/: на ней есть фильтр, ссылки в карточки и популярные районы из `RealtyOffer`.

## 2025-12-16

- Добавил на публичную страницу `/search/` явную пометку «Приложение поиск недвижимости публичный», чтобы можно было визуально отличить стенд.
- Обновление выложил на сервер `83.166.245.64` (скопировал шаблон и перезапустил `realty.service`).
- Очистил публичную `/search/`, оставив только шапку как на главной (top-bar) без остального контента.
- Перенаправил публичную `/search/` на тот же лендинг, что и главная: View теперь отдаёт `soyz.html` напрямую.
- Перенёс ссылку входа из хедера в блок контактов на главной/лендинге `soyz.html` и убрал её из шапки.
- Для публичной `/search/` удаляю любые ссылки на `/admin-panel/login/` при отдаче контента.
- В `soyz.html` полностью переразметил кастомный хедер: сетка 1/2/1 с логотипом слева, навигацией по центру и телефоном справа, спрятал тильдовский хедер, добавил отступы body; затем вернул хедер к нейтральному виду без подсветки зон.
- Локальный логотип (`static/logo.png`) залил на сервер и в каталог раздачи статики, включил `?v=1` в ссылке для сброса кеша.
- Убрал кнопку быстрого входа в кабинет главного менеджера на странице `/admin-panel/login/`; теперь вход только через логин/пароль (`admin`/`admin`).
